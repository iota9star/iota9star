name: GitHub-Profile-Automation

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  automated-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: run-automated-tasks
    steps:
      - uses: actions/checkout@v4

      - name: Generate 3D Profile Contrib
        uses: yoshi389111/github-profile-3d-contrib@v0.9.1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
          MAX_REPOS: 999

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          claude_args: --allowedTools Write,Edit,Read,Glob,Grep,Bash(gh:*),Bash(curl:*)
          prompt: |
            You are a creative GitHub profile designer. Generate a fresh, engaging README.md from the profile.md data.

            ## Data Collection
            1. Read profile.md for personal info (content before <!-- REPOS -->)
            2. Extract repo links from <!-- REPOS --> section
            3. Use gh CLI to fetch project details (stars, description) - query ONE BY ONE to avoid rate limits
            4. Sort by popularity (stars descending)
            5. **CRITICAL**: Download each gh-card SVG to local temp file:
               - Use Bash with curl: `curl -s https://gh-card.dev/repos/owner/repo.svg -o temp/repo-owner-repo.svg`
               - Create temp directory first: `mkdir -p temp`
               - Download ALL cards before proceeding
            6. **CRITICAL**: Read each downloaded SVG file to extract actual dimensions:
               - Use Read tool to parse SVG width/height from the file
               - Store dimensions for layout calculation
               - Example: parse `width="400" height="200"` or viewBox attributes

            ## README Generation - RICH & COMPACT

            **Core Requirements:**
            - Use GitHub Cards: <a href="repo-url"><img src="https://gh-card.dev/repos/owner/repo.svg"></a>
            - **CRITICAL: Display repo cards in MASONRY/WATERFALL layout using SVG with calculated positions**
            - Include a quote from: curl -s https://v1.hitokoto.cn/
            - Write in English
            - Use the Write tool to save the generated content to README.md
            - Replace entire README.md content (do not merge with existing)

            **Content Guidelines - RICH & COMPREHENSIVE:**

            Generate a CONTENT-RICH profile with MULTIPLE sections:
            - Include 5-7 different sections minimum (not just intro+projects)
            - Add diverse content: about, skills, stats, projects, quote, contact, highlights
            - Make it feel complete and comprehensive, not minimal
            - Each section should have substantive content, not just headers
            - Use detailed descriptions where appropriate
            - Add contextual information around projects
            - Include personal touches: interests, philosophy, approach
            - Make visitors feel they learned something about you

            **Layout Guidelines - COMPACT SPACING:**

            While keeping content rich, use COMPACT spacing:
            - Use ONLY single blank lines between sections (never double+)
            - No unnecessary empty lines at start/end
            - Compact but not cramped - readable but efficient
            - Minimize vertical whitespace while maximizing content
            - **DO NOT use horizontal separators (---) between sections**

            **Emoji Guidelines - USE FREELY & CREATIVELY:**

            Emojis make the profile visually engaging and organized:
            - Use 10-20+ emojis throughout the README
            - Different emojis for different sections for visual hierarchy
            - Section headers with emojis: üë®‚Äçüíª About, üõ†Ô∏è Tech Stack, üìä Projects, üí¨ Contact
            - Use emojis in lists as bullet points
            - Emojis for skill tags and highlights
            - Inline emojis within text for visual breaks
            - Be creative and generous with emoji usage
            - Match emoji to content context

            **Markdown Formatting Rules - CRITICAL - MUST FOLLOW:**

            GitHub Markdown line break rules:
            - To break a line WITHOUT creating a new paragraph: add EXACTLY TWO SPACES at end of line, then press ENTER
            - To create a new paragraph: press ENTER alone (this creates blank line)
            - EXAMPLE: Line 1 ends with two spaces  [ENTER]Line 2 continues here
            - When writing the README, EVERY time you want text to continue on next line (without gap), you MUST add "  " (two spaces) before pressing ENTER
            - This is MANDATORY for inline content, lists, and any compact formatting
            - FAILURE to add two spaces will create paragraph breaks instead of line breaks

            **Masonry/Waterfall Layout Pattern with SVG:**

            Use inline SVG for true masonry waterfall layout. Calculate positions based on ACTUAL card dimensions:

            **Algorithm:**
            1. Track two columns: left_y and right_y (both start at 0)
            2. For each card:
               - Place in column with LOWER current height
               - Set x=0 for left, x=50.5% for right
               - Set y=current_column_height
               - Update that column's height: += card_height + gap (gap=8px)
            3. Final SVG height = max(left_y, right_y)

            **Implementation Example:**
            ```markdown
            <!-- Suppose after downloading we found:
                 card1: 400x200, card2: 400x180, card3: 400x220, card4: 400x160
                 Calculation:
                 card1 ‚Üí left(0,0),   left_y=208
                 card2 ‚Üí right(50.5%,0), right_y=188
                 card3 ‚Üí left(0,208),  left_y=436  (188 < 208, place left)
                 card4 ‚Üí right(50.5%,188), right_y=356 (208 < 188? no, place right)
            -->
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="436">
              <a href="repo1-url">
                <image x="0" y="0" width="49.5%" height="200" href="temp/repo-owner-repo1.svg"/>
              </a>
              <a href="repo2-url">
                <image x="50.5%" y="0" width="49.5%" height="180" href="temp/repo-owner-repo2.svg"/>
              </a>
              <a href="repo3-url">
                <image x="0" y="208" width="49.5%" height="220" href="temp/repo-owner-repo3.svg"/>
              </a>
              <a href="repo4-url">
                <image x="50.5%" y="188" width="49.5%" height="160" href="temp/repo-owner-repo4.svg"/>
              </a>
            </svg>
            ```

            **CRITICAL Steps:**
            - MUST download SVGs FIRST using curl to temp/ directory
            - MUST read each SVG file to extract REAL width and height
            - MUST calculate positions using the masonry algorithm above
            - Reference local temp files in href, not remote URLs

            **Suggested Sections (include multiple for richness):**
            - üë®‚Äçüíª About / Introduction (detailed, with personality)
            - üéØ Focus Areas / What I Do
            - üõ†Ô∏è Tech Stack / Skills (as emoji badges)
            - üìä Quick Stats (repos, stars, languages, etc.)
            - üî• Featured Projects (the repo cards with context)
            - üí° Quote / Philosophy
            - üèÜ Highlights / Achievements
            - üìß Contact / Social Links
            - üí≠ Interests / Approach

            **Visual Style:**
            - Rich content with 5-7+ substantive sections
            - Colorful and engaging with 10-20+ emojis
            - Compact spacing (single blank lines)
            - **NO horizontal separators (---)**
            - Professional yet personality-filled
            - Information-dense but easy to scan
            - Feels complete and comprehensive

            Goal: Create a RICH, COLORFUL, COMPREHENSIVE GitHub profile. Lots of content sections, lots of emojis, but with compact efficient spacing. Make it feel like a complete portfolio that truly represents you.

            **CRITICAL: After generating the README content, you MUST use the Write tool to save it to README.md.**

          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.CLAUDE_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.CLAUDE_API_BASE_URL }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ secrets.CLAUDE_MODEL }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ secrets.CLAUDE_MODEL }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ secrets.CLAUDE_MODEL }}

      - name: Commit & Push All Changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'Automated update of GitHub profile README.md'
          commit_user_name: github-actions
          commit_user_email: github-actions@github.com
