name: GitHub-Profile-Automation

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  automated-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    name: run-automated-tasks
    steps:
      - uses: actions/checkout@v4

      - name: Generate 3D Profile Contrib
        uses: yoshi389111/github-profile-3d-contrib@v0.9.1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          USERNAME: ${{ github.repository_owner }}
          MAX_REPOS: 999

      - name: Generate README with Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          claude_args: --allowedTools Write,Edit,Read,Glob,Grep,Bash(python\:scripts/generate_masonry.py\ *),Bash(gh\ *),Bash(curl\ *)
          prompt: |
            You are a creative GitHub profile designer. Generate a fresh, engaging README.md from the profile.md data.

            ## Step 1: Data Collection
            1. Read profile.md for personal info (content before <!-- REPOS -->)
            2. Extract repo links from <!-- REPOS --> section
            3. Use gh CLI to fetch project details (stars, description) - query ONE BY ONE to avoid rate limits
            4. Sort repos by popularity (stars descending)

            ## Step 2: Calculate Masonry Layout
            **CRITICAL**: Use the Python masonry tool to calculate layout positions:

            ```bash
            python scripts/generate_masonry.py owner/repo1 owner/repo2 owner/repo3 ...
            ```

            The tool will output JSON with:
            - viewbox_width: SVG viewBox width (800)
            - viewbox_height: SVG viewBox height (total layout height)
            - cards: array with x, y, width, height for each repo (all in pixels)

            Example output:
            ```json
            {
              "viewbox_width": 800,
              "viewbox_height": 1062,
              "cards": [
                {"repo": "owner/repo1", "x": 0, "y": 0, "width": 400, "height": 130},
                {"repo": "owner/repo2", "x": 400, "y": 0, "width": 400, "height": 109}
              ]
            }
            ```

            ## Step 3: Generate README Content

            **Core Requirements:**
            - Use the layout data from Step 2 to create masonry SVG
            - Include rich, diverse content sections
            - Write in English
            - Use compact spacing (single blank lines)
            - Add 10-20+ emojis for visual engagement
            - NO horizontal separators (---)

            **Suggested Sections:**
            - üë®‚Äçüíª About Me (detailed introduction with personality)
            - üéØ What I Do (focus areas and expertise)
            - üõ†Ô∏è Tech Stack (expand from profile.md with emoji badges)
            - üìä Quick Stats (repos, stars, contributions)
            - üî• Featured Projects (the masonry layout goes here)
            - üí° Quote (fetch from https://v1.hitokoto.cn/)
            - üèÜ Highlights / Achievements
            - üìß Connect (social links)
            - üí≠ Philosophy / Approach

            **Masonry SVG Generation Pattern:**
            ```markdown
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 {viewbox_width} {viewbox_height}">
              <a href="https://github.com/{repo}">
                <image x="{x}" y="{y}" width="{width}" height="{height}" href="https://gh-card.dev/repos/{repo}.svg"/>
              </a>
              <!-- Repeat for all cards from layout data -->
            </svg>
            ```
            IMPORTANT:
            - Use viewBox for responsive scaling (e.g., viewBox="0 0 800 1062")
            - All coordinates in pixels (not percentages)
            - Left column: x=0, Right column: x=400
            - Cards will maintain aspect ratio automatically

            **Markdown Formatting:**
            - To break line without paragraph: add TWO SPACES at end of line
            - Single blank lines between sections
            - No unnecessary empty lines

            **Visual Style:**
            - Rich content with 5-7+ substantive sections
            - Colorful with 10-20+ emojis
            - Professional yet personality-filled
            - Information-dense but easy to scan

            **CRITICAL: After generating content, use the Write tool to save it to README.md.**

          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.CLAUDE_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.CLAUDE_API_BASE_URL }}
          ANTHROPIC_DEFAULT_HAIKU_MODEL: ${{ secrets.CLAUDE_MODEL }}
          ANTHROPIC_DEFAULT_SONNET_MODEL: ${{ secrets.CLAUDE_MODEL }}
          ANTHROPIC_DEFAULT_OPUS_MODEL: ${{ secrets.CLAUDE_MODEL }}

      - name: Commit & Push All Changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: 'Automated update of GitHub profile README.md'
          commit_user_name: github-actions
          commit_user_email: github-actions@github.com
